$(function() {

	$("#download-theme").click(function() {
		// HACK - need to temporarily (I hope) show code examples for segmented bar and tabview
		$("#segmented-example").text("<SegmentedBar selectedBackgroundColor='" + $("#ios-seg-bar").spectrum("get") +"'>");
		$("#tabview-example").text("<TabView selectedColor='" + $("#tab-label-text-color").spectrum("get") +"' tabsBackgroundColor='" + $("#tab-bar-color").spectrum("get") +"'>");
		
		// open the download modal
		var inst = $("[data-remodal-id=loadDownloadModal]").remodal();
		inst.open();
	});

	// magical code to create and download a file on the client side

	$("#download-css").click(function() {
		
		// loop through relations.json to associate selected widget values with the tns class name equivalents
		$.getJSON("scripts/data/relations.json", function(data){

			var css = "data:text/css;charset=UTF-8,/* generated by nativescriptthemebuilder.com */";

			$.each(data, function (index, value) {
				
				var elementId = value.id;
				var element = $("#" + elementId);

				// get element class, this will tell us if it's a color picker or text input
				var elementClass = element.attr("class");

				var output = "";

				if (elementClass == "enable-cp") {
					output = element.spectrum("get");
				} else if (elementClass == "enable-txt") {
					output = element.val();
				}

				// loop through iframes
				$.each(value.iframe, function (index, valueIframe) {
					var iframe = valueIframe.id;
					// loop through tns css attributes
					$.each(value.tns, function (index, valueTns) {
						css += valueTns.class + "{" + valueTns.attr + ": " + output + ";} ";
					});
				});

			});

			downloadURI(css, "custom.css");

		});
	});

});

function downloadURI(uri, name) {
	var link = document.createElement("a");
	link.download = name;
	link.href = uri;
	document.body.appendChild(link);
	link.click();
	document.body.removeChild(link);
	delete link;
}